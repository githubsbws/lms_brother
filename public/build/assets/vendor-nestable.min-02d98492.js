(function(a,r,h,m){function u(t,s){this.w=a(h),this.el=a(t),this.options=a.extend({},v,s),this.init()}var N="ontouchstart"in h,E=function(){var t=h.createElement("div"),s=h.documentElement;if(!("pointerEvents"in t.style))return!1;t.style.pointerEvents="auto",t.style.pointerEvents="x",s.appendChild(t);var d=r.getComputedStyle&&r.getComputedStyle(t,"").pointerEvents==="auto";return s.removeChild(t),!!d}(),v={listNodeName:"ol",itemNodeName:"li",rootClass:"dd",listClass:"dd-list",itemClass:"dd-item",dragClass:"dd-dragel",handleClass:"dd-handle",collapsedClass:"dd-collapsed",placeClass:"dd-placeholder",noDragClass:"dd-nodrag",emptyClass:"dd-empty",expandBtnHTML:'<button data-action="expand" type="button">Expand</button>',collapseBtnHTML:'<button data-action="collapse" type="button">Collapse</button>',group:0,maxDepth:5,threshold:20};u.prototype={init:function(){var t=this;t.reset(),t.el.data("nestable-group",this.options.group),t.placeEl=a('<div class="'+t.options.placeClass+'"/>'),a.each(this.el.find(t.options.itemNodeName),function(o,n){t.setParent(a(n))}),t.el.on("click","button",function(o){if(!t.dragEl){var n=a(o.currentTarget),i=n.data("action"),e=n.parent(t.options.itemNodeName);i==="collapse"&&t.collapseItem(e),i==="expand"&&t.expandItem(e)}});var s=function(o){var n=a(o.target);if(!n.hasClass(t.options.handleClass)){if(n.closest("."+t.options.noDragClass).length)return;n=n.closest("."+t.options.handleClass)}n.length&&!t.dragEl&&(t.isTouch=/^touch/.test(o.type),t.isTouch&&o.touches.length!==1||(o.preventDefault(),t.dragStart(o.touches?o.touches[0]:o)))},d=function(o){t.dragEl&&(o.preventDefault(),t.dragMove(o.touches?o.touches[0]:o))},l=function(o){t.dragEl&&(o.preventDefault(),t.dragStop(o.touches?o.touches[0]:o))};N&&(t.el[0].addEventListener("touchstart",s,!1),r.addEventListener("touchmove",d,!1),r.addEventListener("touchend",l,!1),r.addEventListener("touchcancel",l,!1)),t.el.on("mousedown",s),t.w.on("mousemove",d),t.w.on("mouseup",l)},serialize:function(){var t=0,s=this;return step=function(d,l){var o=[],n=d.children(s.options.itemNodeName);return n.each(function(){var i=a(this),e=a.extend({},i.data()),p=i.children(s.options.listNodeName);p.length&&(e.children=step(p,l+1)),o.push(e)}),o},step(s.el.find(s.options.listNodeName).first(),t)},serialise:function(){return this.serialize()},reset:function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0},this.isTouch=!1,this.moving=!1,this.dragEl=null,this.dragRootEl=null,this.dragDepth=0,this.hasNewRoot=!1,this.pointEl=null},expandItem:function(t){t.removeClass(this.options.collapsedClass),t.children('[data-action="expand"]').hide(),t.children('[data-action="collapse"]').show(),t.children(this.options.listNodeName).show()},collapseItem:function(t){var s=t.children(this.options.listNodeName);s.length&&(t.addClass(this.options.collapsedClass),t.children('[data-action="collapse"]').hide(),t.children('[data-action="expand"]').show(),t.children(this.options.listNodeName).hide())},expandAll:function(){var t=this;t.el.find(t.options.itemNodeName).each(function(){t.expandItem(a(this))})},collapseAll:function(){var t=this;t.el.find(t.options.itemNodeName).each(function(){t.collapseItem(a(this))})},setParent:function(t){t.children(this.options.listNodeName).length&&(t.prepend(a(this.options.expandBtnHTML)),t.prepend(a(this.options.collapseBtnHTML))),t.children('[data-action="expand"]').hide()},unsetParent:function(t){t.removeClass(this.options.collapsedClass),t.children("[data-action]").remove(),t.children(this.options.listNodeName).remove()},dragStart:function(t){var s=this.mouse,d=a(t.target),l=d.closest(this.options.itemNodeName);this.placeEl.css("height",l.height()),s.offsetX=t.offsetX!==m?t.offsetX:t.pageX-d.offset().left,s.offsetY=t.offsetY!==m?t.offsetY:t.pageY-d.offset().top,s.startX=s.lastX=t.pageX,s.startY=s.lastY=t.pageY,this.dragRootEl=this.el,this.dragEl=a(h.createElement(this.options.listNodeName)).addClass(this.options.listClass+" "+this.options.dragClass),this.dragEl.css("width",l.width()),l.after(this.placeEl),l[0].parentNode.removeChild(l[0]),l.appendTo(this.dragEl),a(h.body).append(this.dragEl),this.dragEl.css({left:t.pageX-s.offsetX,top:t.pageY-s.offsetY});var o,n,i=this.dragEl.find(this.options.itemNodeName);for(o=0;o<i.length;o++)n=a(i[o]).parents(this.options.listNodeName).length,n>this.dragDepth&&(this.dragDepth=n)},dragStop:function(){var t=this.dragEl.children(this.options.itemNodeName).first();t[0].parentNode.removeChild(t[0]),this.placeEl.replaceWith(t),this.dragEl.remove(),this.el.trigger("change"),this.hasNewRoot&&this.dragRootEl.trigger("change"),this.reset()},dragMove:function(t){var s,d,l,o,n,i=this.options,e=this.mouse;this.dragEl.css({left:t.pageX-e.offsetX,top:t.pageY-e.offsetY}),e.lastX=e.nowX,e.lastY=e.nowY,e.nowX=t.pageX,e.nowY=t.pageY,e.distX=e.nowX-e.lastX,e.distY=e.nowY-e.lastY,e.lastDirX=e.dirX,e.lastDirY=e.dirY,e.dirX=e.distX===0?0:e.distX>0?1:-1,e.dirY=e.distY===0?0:e.distY>0?1:-1;var p=Math.abs(e.distX)>Math.abs(e.distY)?1:0;if(!e.moving)return e.dirAx=p,void(e.moving=!0);e.dirAx!==p?(e.distAxX=0,e.distAxY=0):(e.distAxX+=Math.abs(e.distX),e.dirX!==0&&e.dirX!==e.lastDirX&&(e.distAxX=0),e.distAxY+=Math.abs(e.distY),e.dirY!==0&&e.dirY!==e.lastDirY&&(e.distAxY=0)),e.dirAx=p,e.dirAx&&e.distAxX>=i.threshold&&(e.distAxX=0,l=this.placeEl.prev(i.itemNodeName),e.distX>0&&l.length&&!l.hasClass(i.collapsedClass)&&(s=l.find(i.listNodeName).last(),n=this.placeEl.parents(i.listNodeName).length,n+this.dragDepth<=i.maxDepth&&(s.length?(s=l.children(i.listNodeName).last(),s.append(this.placeEl)):(s=a("<"+i.listNodeName+"/>").addClass(i.listClass),s.append(this.placeEl),l.append(s),this.setParent(l)))),e.distX<0&&(o=this.placeEl.next(i.itemNodeName),o.length||(d=this.placeEl.parent(),this.placeEl.closest(i.itemNodeName).after(this.placeEl),d.children().length||this.unsetParent(d.parent()))));var c=!1;if(E||(this.dragEl[0].style.visibility="hidden"),this.pointEl=a(h.elementFromPoint(t.pageX-h.body.scrollLeft,t.pageY-(r.pageYOffset||h.documentElement.scrollTop))),E||(this.dragEl[0].style.visibility="visible"),this.pointEl.hasClass(i.handleClass)&&(this.pointEl=this.pointEl.parent(i.itemNodeName)),this.pointEl.hasClass(i.emptyClass))c=!0;else if(!this.pointEl.length||!this.pointEl.hasClass(i.itemClass))return;var g=this.pointEl.closest("."+i.rootClass),f=this.dragRootEl.data("nestable-id")!==g.data("nestable-id");if(!e.dirAx||f||c){if(f&&i.group!==g.data("nestable-group")||(n=this.dragDepth-1+this.pointEl.parents(i.listNodeName).length,n>i.maxDepth))return;var C=t.pageY<this.pointEl.offset().top+this.pointEl.height()/2;d=this.placeEl.parent(),c?(s=a(h.createElement(i.listNodeName)).addClass(i.listClass),s.append(this.placeEl),this.pointEl.replaceWith(s)):C?this.pointEl.before(this.placeEl):this.pointEl.after(this.placeEl),d.children().length||this.unsetParent(d.parent()),this.dragRootEl.find(i.itemNodeName).length||this.dragRootEl.append('<div class="'+i.emptyClass+'"/>'),f&&(this.dragRootEl=g,this.hasNewRoot=this.el[0]!==this.dragRootEl[0])}}},a.fn.nestable=function(t){var s=this,d=this;return s.each(function(){var l=a(this).data("nestable");l?typeof t=="string"&&typeof l[t]=="function"&&(d=l[t]()):(a(this).data("nestable",new u(this,t)),a(this).data("nestable-id",new Date().getTime()))}),d||s}})(window.jQuery||window.Zepto,window,document);
